# Деплой на Vercel

## 1. Переменные окружения

В настройках проекта Vercel (Settings → Environment Variables) добавьте:

- `DB_HOST` — хост PostgreSQL (например `31.207.77.167`)
- `DB_PORT` — порт (обычно `5432`)
- `DB_NAME` — имя БД
- `DB_USER` — пользователь
- `DB_PASSWORD` — пароль

Опционально:

- `DB_CONNECT_TIMEOUT` — таймаут подключения в секундах (по умолчанию 15). На Vercel полезно, чтобы не зависать при недоступности БД.
- `DB_SSLMODE` — режим SSL для PostgreSQL: `require`, `prefer`, `verify-ca`, `verify-full`. Если хостинг БД требует SSL — задайте `require`.

Без обязательных переменных приложение не сможет подключиться к БД.

## 2. Доступ к БД из интернета

Сервер PostgreSQL должен быть доступен снаружи (с Vercel). Если БД в корп. сети или за файрволом, откройте доступ с IP Vercel или используйте облачную БД (Neon, Supabase, Railway и т.п.).

**Если на Vercel вылетает 503 или «Проблема соединения с сервером»:**

1. Проверьте переменные окружения (все пять: DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASSWORD).
2. Убедитесь, что PostgreSQL разрешает подключения с интернета (не только localhost). В `pg_hba.conf` и файрволе должны быть разрешены внешние подключения.
3. Если хостинг БД требует SSL — в Vercel добавьте переменную `DB_SSLMODE` = `require`.
4. В логах деплоя Vercel (Functions → ваша функция → Logs) смотрите тип ошибки в ответе 503 (например `OperationalError` — БД недоступна, `timeout` — таймаут). Увеличьте `DB_CONNECT_TIMEOUT` (секунды), если БД отвечает медленно.

## 3. Деплой через CLI

```bash
npm i -g vercel
vercel login
vercel
```

Либо подключите репозиторий в [vercel.com/new](https://vercel.com/new) — деплой по push.

## 4. Локальная проверка

```bash
pip install -r requirements-vercel.txt
vercel dev
```

## Примечания

- Используется `requirements-vercel.txt` (без Playwright), чтобы уложиться в лимит размера функции.
- На Vercel соединение с БД создаётся на каждый запрос и закрывается после ответа (переменная `VERCEL=1`).
- **Фото:** у серверных функций Vercel лимит тела запроса **4.5 MB**. В приложении фото перед отправкой сжимаются на клиенте (размер до 1280px, JPEG), чтобы запрос с фото укладывался в лимит и сохранялся в БД.
